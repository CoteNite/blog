# 分片，分点，秒传

[本文参考](https://www.cnblogs.com/javastack/p/17210719.html)


原始的上传文件的方式其实是一个连续的过程，前端一直在发送，后端一直在接受，中间不存在暂停或是断网后的重连一类的过程，这对于生成是很难忍受的，因此我们才会需要分片，分点上传。

## 分片上传

在前端要求前端将一个文件拆分成多个小块，然后发送多次请求到后端，后端依次接受这些小片，然后再将其整合为原文件。

### 问题

- 如何将接受到的多个文件整合成一个文件？
- 如何确定哪些文件属于一个文件？

## 断点续传

当出现网络问题或用户主动中断文件上传的过程时，我们会希望恢复到上传状态时文件可以从上次中断的地方继续上传，而不是重新上传，这就是断点上传。

断点上传本身是分片上传的一种延申，因此实现分片上传逻辑的代码都可以很容易的接入断点上传。

## 整体过程

1. 前端将文件按照一定的比例分割，每次上传固定的比例（一个分片），给文件做上序号
2. 后端将前端上传的分片放入一个缓存目录
3. 等待前端将全部文件上传完毕后，发送一个合并文件的请求。
4. 后端使用RandomAccessFile进入多线程读取所有分片，一个线程一个分片
5. 如果出现了断网或暂停，则删除最后一个分片（故障分片）
6. 前端从被删除的那个分片开始重新上传

## 实现步骤

1. 前端将固定大小的文件进行分片，然后请求后端带上分片大小和序号
2. 服务端创建conf文件用来记录分片的位置，conf文件长度为总分片数，每上传一个分片即向conf文件中写入一个127，那么没上传的位置就是默认的0,已上传的就是Byte.MAX_VALUE 127



