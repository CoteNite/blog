# Kotlin元编程

:::tip
本篇为BennyHuo老师的著作《深入理解Kotlin元编程》的读书笔记
:::

## 什么是元编程

所谓元编程，就是操作编程代码的编程，这样说可能很抽象，我们可以先联想一下正常情况下我们的编程是在操作什么，如果是后端开发，那么操作的就是数据，将数据以一种正确的形式返回给消费者，而前端则是操作浏览器，让浏览器可以正确的返回页面的样式给用户。而元编程，就是操作代码，最后生成需要的代码的编程。

元编程最大的意义就是帮助我们消除无用的代码，像是我们最常用的lombok，就是在编译的时刻生成了我们需要的各种方法，同样的，Spring框架核心的AOP底层也是基于元编程实现的

使用元编程编写的程序一般被我们称之为元程序，编写元编程的语言称之为元语言，而被操作的语言称之为目标语言

早在Java5的时候，Java就对元编程在语法层面做出了适配，用来实现元编程的语法称之为**注解**，也被称之为**元编程注解**，同样的反射，APT这些也都属于元编程的范围之内

Kotlin和Java种元编程又分为运行时元编程和编译时元编程，顾名思义，就是在编译时和运行时对代码进行操作，一般运行时元编程是通过反射实现（即调用含有类的反射类的代码实现操作这个类的效果），而编译时元编程就是在编译器进行编译的过程中对编译过程进行干扰，向最终的编译产物中添加我们需要的代码

总之，我们可以将元编程视为一种通过代码生成代码的编程模式

## Kotlin中的元编程

Kotlin编译器在编译阶段会生成一系列的数据结构，包括PSI，FIR，IR。其中PSI，FIR由Kotlin编译器的前端部分处理，.kt文件会先被编译器处理为PSI或FIR，然后再被前端编译器处理成为IR，而不同目标平台的后端编译器会对IR进行进一步编译，以生成我们需要的平台上的代码，比如Kotlin JVM生成的是JVM字节码，Kotlin-JS生成的则是JS代码

由于元编程可以操作编程语言，因此就能使用元编程访问我们代码的任意部分，比如用于生成文档的Dokka就可以访问代码中定义的注释，进而生成更加健全的API文档

我们之前说过，Java/Kotlin中的元编程是基于注解实现的，而注解一般分为源代码可见注解，二进制可见注解和运行时可见注解

:::tip
可见：可以被感知，这里进一步=指会对哪个状态造成影响（因为可见所以才会造成影响）
:::

### 源代码可见注解

这类注解一般会对代码书写（通过IDE提示开发人员）和编译时造成影响，通过对注解类添加@Retention(AnnotationRetention.SOURCE)实现，比较常见的注解就是RequireKotlin注解，这个注解用来提示该注解标记的API所需的最低版本的Kotlin编译器版本，当我们在不正确的编译器版本中使用这个注解，编译器就会直接报错

### 二进制可见注解

二进制可见注解会出现在响编译产物（比如jar包）中，但不会在运行时被感知（也就是说不会对运行起来的代码照成影响），主要通过对注解类添加@Retention(AnnotationRetention.BINARY)实现

Kotlin的空安全就大量的使用了二进制可见注解来兼容Java代码，当Kotlin遇到了被注释为@Nullable的Java代码时就会知道这个部分是可空的，进而在编程过程中使用外部jar包时可以正确的感知出这里是否要用空安全语法

### 运行时可见注解

运行时可见代码是最为常用的注解形式，该注解会出现在编译产物中，并且会对运行时照成影响，通过为注解类添加@Retention(AnnotationRetention.Runtime)实现

