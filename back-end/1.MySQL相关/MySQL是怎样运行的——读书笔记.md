# MySQL是怎样运行的——读书笔记

## 字符集

MySQL中的utf8指的是utf8mb3这个字符集只用到了3个字节，若要使用使用完整的字符集需要使用utf8mb4

### 比较规则

`utf8_general_ci`我们来看这个比较规则，它分为三部分

- utf-8：该规则用于哪个字符集
- general：主要根据哪个语种的特点进行排序，这里的general是一种相对通用的规则
- ci：是否区分重音和大小写

|   后缀   |         英文释义         |    描述    |
| :----: | :------------------: | :------: |
| `_ai`  | `accent insensitive` |  不区分重音   |
| `_as`  |  `accent sensitive`  |   区分重音   |
| `_ci`  |  `case insensitive`  |  不区分大小写  |
| `_cs`  |   `case sensitive`   |  区分大小写   |
| `_bin` |       `binary`       | 以二进制方式比较 |

特别注意的是，每种字符集都有自己默认的比较规则`utf8`字符集默认的比较规则就是`utf8_general_ci`。

**MySQL的编解码顺序**

首先客户端会有一个自己使用的字符集（一般与操作系统一致，Windows使用GBK，类Unix使用utf8），而在接收到客户端发送的字节并将查询到的数据返回给客户端时会用到3个字符集

|            系统变量            |                                 描述                                 |
| :------------------------: | :----------------------------------------------------------------: |
|   `character_set_client`   |                           服务器解码请求时使用的字符集                           |
| `character_set_connection` | 服务器处理请求时会把请求字符串从`character_set_client`转为`character_set_connection` |
|  `character_set_results`   |                         服务器向客户端返回数据时使用的字符集                         |

1. 客户端会以自己的字符集形式发送一段字节给服务端
2. 服务端收到后将客户端的数据认为为`character_set_client`类型，然后转换为`character_set_connection`用于操作
3. 服务端将查询到的数据将其由其自身的字符集转换为`character_set_results`，然后再返回给客户端
4. 客户端接收到服务端返回的数据，再以自身字符集进行解码

## InnoDB

在InnoDB中，我们的数据都是存放在磁盘上，然后在内存中进行操作，而一条条的由内存向磁盘中存取数据太慢，因此InnoDB采用页存储的方式，规定一页为16kb，一次存取的大小最少都是16k，即使你只查询一条数据，InnoDB **最少也会读取16KB的数据到内存中**

**varchar溢出**

众所周知，varchar(M)最多可以存放65535个字节长度的数据，但是实际上M的值并非65535/每个字符的大小，这是因为varchar会使用一些字节来保存信息。

**隐藏主键**

一般的可视化数据库管理数据hui'wei'wo'men

## 页

InnoDB中管理的基本单位为页，其中存放数据的页被称之为索引`Index`页

一个索引页中的大致分为下列7个部分

|名称|中文名|占用空间大小|简单描述|
|:-:|:-:|:-:|:-:|
|`File Header`|文件头部|`38`字节|页的一些通用信息|
|`Page Header`|页面头部|`56`字节|数据页专有的一些信息|
|`Infimum + Supremum`|最小记录和最大记录|`26`字节|两个虚拟的行记录|
|`User Records`|用户记录|不确定|实际存储的行记录内容|
|`Free Space`|空闲空间|不确定|页中尚未使用的空间|
|`Page Directory`|页面目录|不确定|页中的某些记录的相对位置|
|`File Trailer`|文件尾部|`8`字节|校验页是否完整|

当你存储数据时实际上是先充FreeSpace中申请一个空间，然后将数据存放进去，其转变为UserRecords

